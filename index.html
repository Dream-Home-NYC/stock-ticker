<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamHome Market Command - Adaptive</title>
    <style>
        :root { 
            --bg: #000; --panel: #1a1a1a; --adaptiveText: #fff; --border: #333; 
            --up: #00ff00; --down: #ff4444; --news: #00d4ff; --emerald: #50fa7b; --crimson: #ff5555; 
        }
        
        [data-theme="light"] { 
            --bg: #ffffff; --panel: #f4f4f4; --adaptiveText: #000; --border: #ccc; 
            --up: #008800; --down: #cc0000; 
        }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--adaptiveText); overflow: hidden; height: 100vh; display: flex; flex-direction: column; transition: background 0.3s, color 0.3s; }
        
        /* Ticker Layout */
        .ticker-section { width: 100%; overflow: hidden; white-space: nowrap; border-bottom: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; height: 40px; }
        #mid-banner { height: 50px; }
        #news-banner { background: rgba(0,0,0,0.05); border-bottom: 2px solid var(--news); }

        /* Fixed Status Bar */
        #market-status-bar { 
            background: var(--bg); padding: 0 15px; height: 100%; display: flex; 
            align-items: center; gap: 10px; border-right: 2px solid var(--border);
            z-index: 100; font-weight: bold; font-family: monospace; flex-shrink: 0; font-size: 18px;
        }
        #live-date { color: var(--up); }
        
        /* Ticker Items */
        .scroller { display: inline-block; padding-left: 100%; animation: scroll linear infinite; font-weight: bold; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .stock-item { margin-right: 60px; display: inline-block; padding: 2px 8px; border-radius: 4px; }
        .white-text { color: var(--adaptiveText) !important; } 
        .up { color: var(--up); } .down { color: var(--down); }

        /* Breathing Pulse Logic (2% and 3.5%) */
        @keyframes pulse-slow { 0%, 100% { filter: drop-shadow(0 0 1px currentColor); opacity: 1; } 50% { filter: drop-shadow(0 0 8px currentColor); opacity: 0.8; } }
        @keyframes pulse-fast { 0%, 100% { filter: drop-shadow(0 0 2px currentColor); } 50% { filter: drop-shadow(0 0 12px currentColor); } }
        
        .breathing-slow { animation: pulse-slow 3s infinite; text-decoration: underline; text-underline-offset: 5px; }
        .breathing-fast { animation: pulse-fast 1.5s infinite; text-decoration: underline; text-underline-offset: 5px; text-decoration-thickness: 2px; }

        /* High Heat (>5%) */
        .heat-emerald { background: var(--emerald) !important; color: #000 !important; border: 1px solid #000; }
        .heat-crimson { background: var(--crimson) !important; color: #fff !important; border: 1px solid #fff; }
        .heat-emerald .white-text, .heat-emerald .up { color: #000 !important; }

        /* Controls */
        #controls { padding: 15px; flex-grow: 1; transition: opacity 0.5s; overflow-y: auto; }
        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        input, button { padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--adaptiveText); }
        button { cursor: pointer; font-weight: bold; background: #2962ff; color: #fff; border: none; }
    </style>
</head>
<body data-theme="dark">

<div id="top-banner" class="ticker-section">
    <div id="market-status-bar">
        <span id="live-date">--/--/----</span>
        <span id="live-clock" class="white-text">00:00:00</span>
        <span id="status-text" style="font-size:14px">CLOSED</span>
        <span id="cd-time" class="up" style="font-size:14px"></span>
    </div>
    <div id="macro-scroller" class="scroller" style="animation-duration:50s">Loading Indices...</div>
</div>

<div id="mid-banner" class="ticker-section">
    <div id="portfolio-scroller" class="scroller" style="animation-duration:35s">Loading Portfolio...</div>
</div>

<div id="news-banner" class="ticker-section">
    <div id="news-scroller" class="scroller" style="animation-duration:80s">Fetching News...</div>
</div>

<div id="controls">
    <div class="card">
        <input type="text" id="new-stock" placeholder="Symbol" style="width:80px">
        <button onclick="addStock()">ADD</button>
        <button onclick="toggleBold()">BOLD</button>
        <button onclick="toggleTheme()" style="background:#555">THEME</button>
        <span id="last-sync" style="font-size:11px; opacity:0.6">Sync: --:--:--</span>
    </div>
</div>

<script>
    const FINNHUB_KEY = 'd60f5u1r01qto1rctdkgd60f5u1r01qto1rctdl0';
    const PROXY_URL = 'https://api.allorigins.win/get?url=';
    let userStocks = JSON.parse(localStorage.getItem('stocks')) || ['NVDA', 'AAPL', 'TSLA', 'VNQ', 'O'];
    let isBold = localStorage.getItem('tickerBold') === 'true';

    function updateClock() {
        const now = new Date();
        const est = new Intl.DateTimeFormat('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(now);
        const h = est.find(p => p.type === 'hour').value, m = est.find(p => p.type === 'minute').value, s = est.find(p => p.type === 'second').value;
        document.getElementById('live-date').innerText = `${est.find(p => p.type === 'month').value}/${est.find(p => p.type === 'day').value}/${est.find(p => p.type === 'year').value}`;
        document.getElementById('live-clock').innerText = `${h}:${m}:${s}`;
        
        // Simplified Market Logic
        const hr = parseInt(h);
        const isOpen = hr >= 9 && hr < 16;
        document.getElementById('status-text').innerText = isOpen ? 'OPEN' : 'CLOSED';
        document.getElementById('status-text').style.color = isOpen ? 'var(--up)' : 'var(--down)';
    }

    async function refreshAll() {
        // Macro Section
        const macros = [{s:'^DJI', n:'DOW'}, {s:'^IXIC', n:'NASD'}, {s:'^GSPC', n:'S&P'}, {s:'BTC-USD', n:'BTC'}, {s:'ETH-USD', n:'ETH'}];
        let tH = '';
        for (let i of macros) {
            const d = await fetchYahoo(i.s);
            if (d) tH += formatItem(i.n, d, true);
        }
        
        // Mortgage Section (Green if negative change)
        const rates = [{n:'30-YR', r:6.78, c:-0.05}, {n:'15-YR', r:6.12, c:0.02}];
        rates.forEach(r => {
            tH += `<span class="stock-item"><span class="white-text">${r.n}:</span> <span class="${r.c < 0 ? 'up' : 'down'}">${r.r}%</span></span>`;
        });
        
        const vix = await fetchYahoo('^VIX');
        if (vix) tH += `<span class="stock-item"><span class="white-text">VIX:</span> <span class="down">${vix.price.toFixed(2)}</span></span>`;
        document.getElementById('macro-scroller').innerHTML = tH;

        // Portfolio Section
        let mH = '';
        for (let s of userStocks) {
            const d = await fetchFinnhub(s);
            if (d) mH += formatItem(s, d, false);
        }
        document.getElementById('portfolio-scroller').innerHTML = mH;

        // News Section
        const nRes = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_KEY}`);
        const news = await nRes.json();
        document.getElementById('news-scroller').innerHTML = news.slice(0,10).map(n => `<span class="news-item" style="color:var(--news)">NEWS: ${n.headline.toUpperCase()}</span>`).join('');
        
        document.getElementById('last-sync').innerText = `Sync: ${new Date().toLocaleTimeString()}`;
    }

    function formatItem(label, d, isMacro) {
        const isUp = d.change >= 0;
        const colorClass = isUp ? 'up' : 'down';
        let cls = "";
        
        if (!isMacro) {
            const abs = Math.abs(d.percent);
            if (abs >= 5.0) cls = isUp ? "heat-emerald" : "heat-crimson";
            else if (abs >= 3.5) cls = "breathing-fast";
            else if (abs >= 2.0) cls = "breathing-slow";
        }

        return `<span class="stock-item ${cls}">
            <span class="white-text">${label}</span> 
            <span class="white-text">$${d.price.toLocaleString(undefined, {minimumFractionDigits: 2})}</span> 
            <span class="${colorClass}">${isUp?'+':''}${d.change.toFixed(2)} (${isUp?'+':''}${d.percent.toFixed(2)}%)</span>
        </span>`;
    }

    async function fetchYahoo(symbol) {
        try {
            const res = await fetch(`${PROXY_URL}${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`)}`);
            const json = await res.json();
            const d = JSON.parse(json.contents).chart.result[0].meta;
            return { price: d.regularMarketPrice, change: d.regularMarketPrice - d.previousClose, percent: ((d.regularMarketPrice - d.previousClose) / d.previousClose) * 100 };
        } catch (e) { return null; }
    }

    async function fetchFinnhub(symbol) {
        try {
            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`);
            const d = await res.json();
            return { price: d.c, change: d.d, percent: d.dp };
        } catch (e) { return null; }
    }

    function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        body.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    }

    function toggleBold() {
        isBold = !isBold;
        localStorage.setItem('tickerBold', isBold);
        document.querySelectorAll('.scroller').forEach(s => s.style.fontWeight = isBold ? 'bold' : 'normal');
    }

    function addStock() {
        const v = document.getElementById('new-stock').value.toUpperCase().trim();
        if (v && !userStocks.includes(v)) {
            userStocks.push(v);
            localStorage.setItem('stocks', JSON.stringify(userStocks));
            refreshAll();
        }
    }

    setInterval(updateClock, 1000);
    setInterval(refreshAll, 60000);
    refreshAll();
    updateClock();
</script>
</body>
</html>
