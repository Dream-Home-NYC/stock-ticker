<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple-Banner Market Command</title>
    <style>
        :root { --bg: #000; --panel: #1a1a1a; --text: #fff; --border: #333; --up: #00ff00; --down: #ff4444; --news: #00d4ff; }
        [data-theme="light"] { --bg: #fff; --panel: #f4f4f4; --text: #000; --border: #ccc; }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        .ticker-section { width: 100%; overflow: hidden; white-space: nowrap; border-bottom: 1px solid var(--border); background: var(--bg); }
        #top-banner { padding: 6px 0; border-bottom: 2px solid #444; }
        #mid-banner { padding: 10px 0; border-bottom: 2px solid var(--border); }
        #news-banner { padding: 6px 0; background: #050505; border-bottom: 2px solid var(--news); }

        .scroller { display: inline-block; padding-left: 100%; animation: scroll linear infinite; font-weight: bold; line-height: 1.2; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .stock-item { margin-right: 60px; display: inline-block; vertical-align: middle; }
        .news-item { margin-right: 100px; color: var(--news); font-style: italic; display: inline-block; }
        .up { color: var(--up); } .down { color: var(--down); }
        
        /* Alerts */
        @keyframes glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .alert-gold { color: #FFD700 !important; animation: glow 2s infinite; }
        .alert-silver { color: #C0C0C0 !important; animation: glow 2s infinite; }
        .alert-macro { color: #ff9800 !important; animation: glow 2s infinite; }

        /* Controls Panel */
        #controls { padding: 15px; flex-grow: 1; transition: opacity 0.5s; opacity: 1; overflow-y: auto; position: relative; }
        .hidden { opacity: 0 !important; pointer-events: none; }
        .card { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; gap: 4px; font-size: 11px; color: #aaa; }
        input, button { padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        button { cursor: pointer; font-weight: bold; background: #2962ff; color: #fff; border: none; }
        .toggle-btn.active { background: var(--up); color: #000; }
        #update-time { position: absolute; bottom: 10px; right: 20px; font-size: 11px; color: #666; font-family: monospace; }
    </style>
</head>
<body data-theme="dark">

<div id="top-banner" class="ticker-section">
    <div id="macro-scroller" class="scroller">Loading Macro Data...</div>
</div>
<div id="mid-banner" class="ticker-section">
    <div id="portfolio-scroller" class="scroller">Syncing Portfolio...</div>
</div>
<div id="news-banner" class="ticker-section">
    <div id="news-scroller" class="scroller">Fetching Latest Market News...</div>
</div>

<div id="controls">
    <div class="card">
        <div class="control-group">
            SYMBOL
            <input type="text" id="new-stock" placeholder="e.g. NVDA" style="width:80px">
        </div>
        <button onclick="addStock()" style="margin-top:15px">ADD</button>
        
        <div class="control-group">
            FONT SIZE
            <input type="number" id="f-size" value="22" style="width:50px" oninput="updateUI(true)">
        </div>
        
        <div class="control-group">
            MACRO SPEED
            <input type="number" id="speed-macro" value="50" style="width:50px" oninput="updateUI(true)">
        </div>
        
        <div class="control-group">
            STOCKS SPEED
            <input type="number" id="speed-stocks" value="30" style="width:50px" oninput="updateUI(true)">
        </div>
        
        <div class="control-group">
            NEWS SPEED
            <input type="number" id="speed-news" value="80" style="width:50px" oninput="updateUI(true)">
        </div>

        <button id="bold-btn" class="toggle-btn" onclick="toggleBold()" style="margin-top:15px">BOLD</button>
        <button onclick="toggleTheme()" style="background:#555; margin-top:15px">ðŸŒ“ THEME</button>
    </div>
    <div id="active-list" style="margin-top:10px"></div>
    <div id="update-time">Last Update: --:--:--</div>
</div>

<script>
    const FINNHUB_KEY = 'd60f5u1r01qto1rctdkgd60f5u1r01qto1rctdl0';
    const PROXY_URL = 'https://api.allorigins.win/get?url=';
    
    let userStocks = JSON.parse(localStorage.getItem('stocks')) || ['NVDA', 'AAPL', 'TSLA'];
    let isBold = localStorage.getItem('tickerBold') === 'true';

    const macroList = [
        { sym: '^DJI', name: 'DOW' }, { sym: '^IXIC', name: 'NASDAQ' }, { sym: '^GSPC', name: 'S&P 500' },
        { sym: 'GC=F', name: 'GOLD' }, { sym: 'SI=F', name: 'SILVER' }, { sym: 'CL=F', name: 'CRUDE OIL' },
        { sym: 'BTC-USD', name: 'BITCOIN' }, { sym: 'ETH-USD', name: 'ETHEREUM' }
    ];

    async function fetchYahoo(symbol) {
        try {
            const targetUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`);
            const res = await fetch(`${PROXY_URL}${targetUrl}`);
            const jsonWrapper = await res.json();
            const data = JSON.parse(jsonWrapper.contents);
            const meta = data.chart.result[0].meta;
            return { price: meta.regularMarketPrice, change: meta.regularMarketPrice - meta.previousClose, percent: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100 };
        } catch (e) { return null; }
    }

    async function fetchFinnhub(symbol) {
        try {
            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`);
            const data = await res.json();
            return data.c ? { price: data.c, change: data.d, percent: data.dp } : null;
        } catch (e) { return null; }
    }

    async function fetchNews() {
        try {
            const res = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_KEY}`);
            const data = await res.json();
            return data.slice(0, 10).map(item => item.headline);
        } catch (e) { return ["News feed busy..."]; }
    }

    async function refreshAll() {
        let topHtml = '';
        for (const item of macroList) {
            const d = await fetchYahoo(item.sym);
            if (d) topHtml += formatItem(item.name, d, true);
        }
        document.getElementById('macro-scroller').innerHTML = topHtml;

        let midHtml = '';
        for (const sym of userStocks) {
            const d = await fetchFinnhub(sym);
            if (d) midHtml += formatItem(sym, d, false);
        }
        document.getElementById('portfolio-scroller').innerHTML = midHtml;

        const headlines = await fetchNews();
        document.getElementById('news-scroller').innerHTML = headlines.map(h => `<span class="news-item">NEWS: ${h.toUpperCase()}</span>`).join('');

        const now = new Date();
        document.getElementById('update-time').innerText = `Last Update: ${now.toLocaleTimeString()}`;
        renderTags();
        updateUI(false);
    }

    function formatItem(label, d, isMacro) {
        const isUp = d.change >= 0;
        let alertClass = '';
        if (Math.abs(d.percent) >= 3.0) {
            if (label === 'GOLD') alertClass = 'alert-gold';
            else if (label === 'SILVER') alertClass = 'alert-silver';
            else alertClass = 'alert-macro';
        } else if (!isMacro && Math.abs(d.percent) >= 2.0) alertClass = 'alert-macro';

        const priceDisp = (label.includes('BITCOIN') || label.includes('ETHEREUM')) 
            ? d.price.toLocaleString(undefined, {maximumFractionDigits: 0}) 
            : d.price.toLocaleString(undefined, {minimumFractionDigits: 2});

        return `<span class="stock-item ${alertClass}">${label} $${priceDisp} <span class="${isUp?'up':'down'}">${isUp?'+':''}${d.change.toFixed(2)} (${isUp?'+':''}${d.percent.toFixed(2)}%)</span></span>`;
    }

    let hideTimeout;
    function resetTimer() {
        document.getElementById('controls').classList.remove('hidden');
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => document.getElementById('controls').classList.add('hidden'), 10000);
    }
    ['mousemove','click','touchstart'].forEach(e => window.addEventListener(e, resetTimer));

    function updateUI(shouldSave) {
        const sizeInput = document.getElementById('f-size');
        const sMacro = document.getElementById('speed-macro');
        const sStocks = document.getElementById('speed-stocks');
        const sNews = document.getElementById('speed-news');

        if (!shouldSave) {
            sizeInput.value = localStorage.getItem('tickerFontSize') || '22';
            sMacro.value = localStorage.getItem('speedMacro') || '50';
            sStocks.value = localStorage.getItem('speedStocks') || '30';
            sNews.value = localStorage.getItem('speedNews') || '80';
        }

        const fSize = sizeInput.value + 'px';
        const fWeight = isBold ? 'bold' : 'normal';

        document.getElementById('macro-scroller').style.fontSize = fSize;
        document.getElementById('macro-scroller').style.fontWeight = fWeight;
        document.getElementById('macro-scroller').style.animationDuration = sMacro.value + 's';

        document.getElementById('portfolio-scroller').style.fontSize = fSize;
        document.getElementById('portfolio-scroller').style.fontWeight = fWeight;
        document.getElementById('portfolio-scroller').style.animationDuration = sStocks.value + 's';

        document.getElementById('news-scroller').style.fontSize = fSize;
        document.getElementById('news-scroller').style.fontWeight = fWeight;
        document.getElementById('news-scroller').style.animationDuration = sNews.value + 's';

        document.getElementById('bold-btn').className = isBold ? 'toggle-btn active' : 'toggle-btn';
        
        if (shouldSave) {
            localStorage.setItem('tickerFontSize', sizeInput.value);
            localStorage.setItem('speedMacro', sMacro.value);
            localStorage.setItem('speedStocks', sStocks.value);
            localStorage.setItem('speedNews', sNews.value);
        }
    }

    function addStock() {
        const val = document.getElementById('new-stock').value.toUpperCase().trim();
        if (val && !userStocks.includes(val)) {
            userStocks.push(val);
            localStorage.setItem('stocks', JSON.stringify(userStocks));
            refreshAll();
            document.getElementById('new-stock').value = '';
        }
    }
    function removeStock(s) { userStocks = userStocks.filter(x => x !== s); localStorage.setItem('stocks', JSON.stringify(userStocks)); refreshAll(); }
    function renderTags() { document.getElementById('active-list').innerHTML = userStocks.map(s => `<span style="background:var(--border); padding:5px 10px; margin:5px; border-radius:4px; display:inline-block;">${s} <b onclick="removeStock('${s}')" style="cursor:pointer;color:var(--down);margin-left:5px">Ã—</b></span>`).join(''); }
    function toggleBold() { isBold = !isBold; localStorage.setItem('tickerBold', isBold); updateUI(true); }
    function toggleTheme() { const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t); }

    document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
    setInterval(refreshAll, 60000);
    refreshAll();
    resetTimer();
</script>
</body>
</html>
