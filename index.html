<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamHome Market Command</title>
    <style>
        :root { --bg: #000; --panel: #1a1a1a; --text: #fff; --border: #333; --up: #00ff00; --down: #ff4444; --news: #00d4ff; --emerald: #50fa7b; --crimson: #ff5555; }
        [data-theme="light"] { --bg: #fff; --panel: #f4f4f4; --text: #000; --border: #ccc; }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* Ticker Sections */
        .ticker-section { width: 100%; overflow: hidden; white-space: nowrap; border-bottom: 1px solid var(--border); background: var(--bg); cursor: pointer; display: flex; align-items: center; transition: background 0.5s ease; }
        #top-banner { padding: 6px 0; border-bottom: 2px solid #444; height: 40px; }
        #mid-banner { padding: 10px 0; border-bottom: 2px solid var(--border); height: 50px; }
        #news-banner { padding: 6px 0; background: #050505; border-bottom: 2px solid var(--news); height: 40px; }

        /* Status Bar (18px fixed) */
        #market-status-bar { 
            background: var(--bg); padding: 0 15px; height: 100%; display: flex; 
            align-items: center; gap: 10px; border-right: 2px solid var(--border);
            z-index: 100; font-weight: bold; font-family: monospace; flex-shrink: 0; font-size: 18px;
        }
        #live-date { color: var(--up); }
        
        /* Countdown & Blinking */
        .cd-label { color: var(--news); } 
        .cd-timer { color: var(--up); }   
        @keyframes urgent-blink { 0%, 100% { color: var(--down); opacity: 1; } 50% { opacity: 0.3; } }
        .urgent-bell { animation: urgent-blink 1s infinite !important; }

        /* Economic Event Alerts */
        .event-alert { color: #000; font-weight: 900; background: #f1fa8c; padding: 0 10px; border-radius: 4px; margin-right: 50px; border: 1px solid #fff; display: inline-flex; align-items: center; }
        .volatility-warning { background: #f1fa8c !important; border-bottom: 2px solid #000 !important; }
        .volatility-warning .news-item { color: #000 !important; }

        .scroller { display: inline-block; padding-left: 100%; animation: scroll linear infinite; font-weight: bold; line-height: 1.2; }
        .ticker-section:hover .scroller { animation-play-state: paused !important; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .stock-item { margin-right: 60px; display: inline-block; vertical-align: middle; padding: 2px 8px; border-radius: 4px; }
        .news-item { margin-right: 100px; color: var(--news); font-style: italic; display: inline-block; }
        .up { color: var(--up); } .down { color: var(--down); }
        
        /* Heat Formatting (>5%) */
        .heat-emerald { color: #000 !important; background: var(--emerald); border: 2px solid #fff; box-shadow: 0 0 10px var(--emerald); }
        .heat-crimson { color: #fff !important; background: var(--crimson); border: 2px solid #fff; box-shadow: 0 0 10px var(--crimson); }

        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .open-dot { background: var(--up); box-shadow: 0 0 8px var(--up); }
        .closed-dot { background: var(--down); box-shadow: 0 0 8px var(--down); }

        #controls { padding: 15px; flex-grow: 1; transition: opacity 0.5s; overflow-y: auto; }
        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        button { cursor: pointer; font-weight: bold; background: #2962ff; color: #fff; border: none; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body data-theme="dark">

<div id="top-banner" class="ticker-section">
    <div id="market-status-bar">
        <span id="live-date">--/--/----</span>
        <span id="live-clock">00:00:00</span>
        <div id="status-indicator" class="status-dot closed-dot"></div>
        <span id="status-text" class="down">CLOSED</span>
        <span id="countdown-wrap">
            <span id="cd-text" class="cd-label"></span> 
            <span id="cd-time" class="cd-timer"></span>
        </span>
        <button id="mute-toggle" onclick="toggleMute()" style="padding:2px 6px; font-size:12px; background:#444; border:none; color:white;">ðŸ”Š</button>
    </div>
    <div id="macro-scroller" class="scroller">Initializing Global Markets...</div>
</div>

<div id="mid-banner" class="ticker-section"><div id="portfolio-scroller" class="scroller">Syncing Stocks...</div></div>
<div id="news-banner" class="ticker-section"><div id="news-scroller" class="scroller">Syncing News...</div></div>

<div id="controls">
    <div class="card">
        <input type="text" id="new-stock" placeholder="SYMBOL" style="width:80px; background:#000; color:#fff; border:1px solid #333; padding:8px;">
        <button onclick="addStock()">ADD</button>
        <button onclick="toggleBold()">BOLD</button>
        <button onclick="toggleTheme()" style="background:#555">THEME</button>
        <button onclick="refreshAll()" style="background:#222">ðŸ”„ REFRESH</button>
        <span id="last-sync" style="font-size:11px; color:#888; font-family:monospace;">Sync: --:--:--</span>
    </div>
    <div id="active-list" style="margin-top:10px"></div>
</div>

<script>
    const FINNHUB_KEY = 'd60f5u1r01qto1rctdkgd60f5u1r01qto1rctdl0';
    const PROXY_URL = 'https://api.allorigins.win/get?url=';
    let userStocks = JSON.parse(localStorage.getItem('stocks')) || ['NVDA', 'AAPL', 'TSLA', 'VNQ', 'O'];
    let isBold = localStorage.getItem('tickerBold') === 'true', isMuted = localStorage.getItem('tickerMuted') === 'true', lastMarketState = null;

    const bellOpen = new Audio('https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg'), bellClose = new Audio('https://actions.google.com/sounds/v1/alarms/mechanical_clock_ring.ogg');

    // --- Holiday & Event Engine ---
    function getNthDay(y, m, dw, n) { let d = new Date(y, m, 1), c = 0; while (d.getMonth() === m) { if (d.getDay() === dw) { c++; if (c === n) return d; } d.setDate(d.getDate() + 1); } return null; }
    function getLastMonday(y, m) { let d = new Date(y, m + 1, 0); while (d.getDay() !== 1) d.setDate(d.getDate() - 1); return d; }
    function isNYSEHoliday(date) { const y = date.getFullYear(), dStr = date.toDateString(); let hols = [new Date(y, 0, 1), getNthDay(y, 0, 1, 3), getNthDay(y, 1, 1, 3), getLastMonday(y, 4), new Date(y, 5, 19), new Date(y, 6, 4), getNthDay(y, 8, 1, 1), getNthDay(y, 10, 4, 4), new Date(y, 11, 25)]; return hols.map(d => { if (d.getDay() === 6) return new Date(d.getFullYear(), d.getMonth(), d.getDate() - 1).toDateString(); if (d.getDay() === 0) return new Date(d.getFullYear(), d.getMonth(), d.getDate() + 1).toDateString(); return d.toDateString(); }).includes(dStr); }

    function getNextMarketEvent(now) {
        let checkDate = new Date(now);
        while (true) {
            const day = checkDate.getDay(), isWeekend = (day === 0 || day === 6), isHoliday = isNYSEHoliday(checkDate);
            const openT = new Date(checkDate).setHours(9, 30, 0, 0), closeT = new Date(checkDate).setHours(16, 0, 0, 0);
            if (!isWeekend && !isHoliday) {
                if (now < openT) return { type: 'open', time: openT };
                if (now < closeT) return { type: 'close', time: closeT };
            }
            checkDate.setDate(checkDate.getDate() + 1); checkDate.setHours(9, 30, 0, 0);
        }
    }

    function updateClock() {
        const now = new Date();
        const est = new Intl.DateTimeFormat('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(now);
        const h = est.find(p => p.type === 'hour').value, m = est.find(p => p.type === 'minute').value, s = est.find(p => p.type === 'second').value;
        document.getElementById('live-date').innerText = `${est.find(p => p.type === 'month').value}/${est.find(p => p.type === 'day').value}/${est.find(p => p.type === 'year').value}`;
        document.getElementById('live-clock').innerText = `${h}:${m}:${s}`;

        const event = getNextMarketEvent(now);
        const diff = Math.floor((event.time - now) / 1000);
        const hh = Math.floor(diff / 3600), mm = Math.floor((diff % 3600) / 60), ss = diff % 60;
        const open = event.type === 'close';
        
        document.getElementById('status-indicator').className = `status-dot ${open ? 'open-dot' : 'closed-dot'}`;
        document.getElementById('status-text').innerText = open ? 'OPEN' : 'CLOSED';
        document.getElementById('status-text').className = open ? 'up' : 'down';
        document.getElementById('cd-text').innerText = open ? 'Closes in' : 'Opens in';
        document.getElementById('cd-time').innerText = `${hh}h ${mm}m ${ss}s`;
        if (diff < 600) document.getElementById('cd-time').classList.add('urgent-bell'); else document.getElementById('cd-time').classList.remove('urgent-bell');
        
        if (!isMuted && lastMarketState) {
            if (open && lastMarketState === 'closed') bellOpen.play();
            if (!open && lastMarketState === 'open') bellClose.play();
        }
        lastMarketState = open ? 'open' : 'closed';
    }

    const macroList = [{ sym: '^DJI', name: 'DOW' }, { sym: '^IXIC', name: 'NASDAQ' }, { sym: '^GSPC', name: 'S&P 500' }, { sym: 'GC=F', name: 'GOLD' }, { sym: 'SI=F', name: 'SILVER' }, { sym: 'CL=F', name: 'OIL' }, { sym: 'BTC-USD', name: 'BTC' }, { sym: 'ETH-USD', name: 'ETH' }];

    async function refreshAll() {
        let tH = ''; 
        for (let i of macroList) {
            const d = await fetchYahoo(i.sym);
            if (d) tH += formatItem(i.name, d, true);
        }
        
        // Mortgage Rates (Simulated Daily Data)
        const rates = [{ n: '30-YR FIXED', r: 6.78, ch: -0.05 }, { n: '15-YR FIXED', r: 6.12, ch: 0.02 }];
        rates.forEach(r => {
            const isBetter = r.ch < 0; // Green if rate dropped
            tH += `<span class="stock-item">${r.n}: <span class="${isBetter ? 'up' : 'down'}">${r.r}% (${isBetter ? '' : '+'}${r.ch})</span></span>`;
        });

        const vix = await fetchYahoo('^VIX');
        if (vix) tH += `<span class="stock-item ${vix.price > 20 ? 'heat-crimson' : ''}">VIX: ${vix.price.toFixed(2)}</span>`;
        document.getElementById('macro-scroller').innerHTML = tH;

        let mH = ''; for (let s of userStocks) { const d = await fetchFinnhub(s); if (d) mH += formatItem(s, d, false); }
        document.getElementById('portfolio-scroller').innerHTML = mH;

        const newsRes = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_KEY}`);
        const news = await newsRes.json();
        document.getElementById('news-scroller').innerHTML = news.slice(0,10).map(h => `<span class="news-item">NEWS: ${h.headline.toUpperCase()}</span>`).join('');
        
        document.getElementById('last-sync').innerText = `Sync: ${new Date().toLocaleTimeString()}`;
        renderTags();
    }

    function formatItem(label, d, isMacro) {
        const isUp = d.change >= 0;
        let cls = "";
        if (!isMacro) {
            if (d.percent >= 5) cls = "heat-emerald";
            else if (d.percent <= -5) cls = "heat-crimson";
        }
        return `<span class="stock-item ${cls}">${label} $${d.price.toLocaleString(undefined, {minimumFractionDigits: 2})} <span class="${cls ? '' : (isUp ? 'up' : 'down')}">${isUp?'+':''}${d.percent.toFixed(2)}%</span></span>`;
    }

    async function fetchYahoo(symbol) {
        try { 
            const res = await fetch(`${PROXY_URL}${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`)}`);
            const json = await res.json();
            const d = JSON.parse(json.contents).chart.result[0].meta;
            return { price: d.regularMarketPrice, change: d.regularMarketPrice - d.previousClose, percent: ((d.regularMarketPrice - d.previousClose) / d.previousClose) * 100 };
        } catch (e) { return null; }
    }
    async function fetchFinnhub(symbol) {
        try { const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`); return await res.json(); } catch (e) { return null; }
    }

    function toggleTheme() { const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
    function toggleBold() { isBold = !isBold; localStorage.setItem('tickerBold', isBold); updateUI(); }
    function updateUI() { document.querySelectorAll('.scroller').forEach(s => s.style.fontWeight = isBold ? 'bold' : 'normal'); }
    function addStock() { const v = document.getElementById('new-stock').value.toUpperCase().trim(); if (v && !userStocks.includes(v)) { userStocks.push(v); localStorage.setItem('stocks', JSON.stringify(userStocks)); refreshAll(); document.getElementById('new-stock').value = ''; } }
    function removeStock(s) { userStocks = userStocks.filter(x => x !== s); localStorage.setItem('stocks', JSON.stringify(userStocks)); refreshAll(); }
    function renderTags() { document.getElementById('active-list').innerHTML = userStocks.map(s => `<span style="background:var(--border); padding:5px 10px; margin:5px; border-radius:4px; display:inline-block;">${s} <b onclick="removeStock('${s}')" style="cursor:pointer;color:var(--down);margin-left:5px">Ã—</b></span>`).join(''); }
    function toggleMute() { isMuted = !isMuted; localStorage.setItem('tickerMuted', isMuted); document.getElementById('mute-toggle').innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š'; }

    setInterval(updateClock, 1000);
    setInterval(refreshAll, 60000);
    refreshAll();
    updateClock();
</script>
</body>
</html>
