<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Stock Ticker</title>
    <style>
        :root { --bg: #000; --panel: #1a1a1a; --text: #fff; --border: #333; }
        [data-theme="light"] { --bg: #fff; --panel: #f4f4f4; --text: #000; --border: #ccc; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        #ticker-wrap { width: 100%; background: var(--bg); padding: 15px 0; border-bottom: 2px solid var(--border); overflow: hidden; white-space: nowrap; }
        #ticker-move { display: inline-block; padding-left: 100%; animation: scroll 35s linear infinite; font-weight: bold; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        @keyframes breathe { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .stock-item { margin-right: 60px; font-size: 24px; display: inline-block; vertical-align: middle; }
        .up { color: #00ff00; } .down { color: #ff4444; }
        .alert { animation: breathe 4s infinite ease-in-out; border-bottom: 2px solid #ff9800; }

        #controls { padding: 20px; flex-grow: 1; transition: opacity 0.5s; opacity: 1; overflow-y: auto; }
        .hidden { opacity: 0 !important; pointer-events: none; }
        .card { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        input, button { padding: 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        button { cursor: pointer; font-weight: bold; background: #2962ff; color: #fff; border: none; }
    </style>
</head>
<body data-theme="dark">

<div id="ticker-wrap">
    <div id="ticker-move">Loading Indices & Portfolio...</div>
</div>

<div id="controls">
    <div class="card">
        <input type="text" id="new-stock" placeholder="Symbol (e.g. NVDA)">
        <button onclick="addStock()">ADD</button>
        <label>Size: <input type="number" id="f-size" value="24" style="width:50px" oninput="updateUI()"></label>
        <label>Speed: <input type="number" id="f-speed" value="35" style="width:50px" oninput="updateUI()"></label>
        <button onclick="toggleTheme()" style="background:#555">ðŸŒ“ Theme</button>
    </div>
    <div id="active-list" style="margin-top:10px"></div>
</div>

<script>
    const FINNHUB_KEY = 'd60f5u1r01qto1rctdkgd60f5u1r01qto1rctdl0';
    let userStocks = JSON.parse(localStorage.getItem('stocks')) || ['NVDA', 'AAPL', 'TSLA'];
    const indices = { '^GSPC': 'S&P 500', '^IXIC': 'NASDAQ', '^DJI': 'DOW' };

    // Proxy to bypass CORS restrictions
    const PROXY_URL = 'https://api.allorigins.win/get?url=';

    async function fetchYahoo(symbol) {
        try {
            const targetUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`);
            const res = await fetch(`${PROXY_URL}${targetUrl}`);
            const jsonWrapper = await res.json();
            const data = JSON.parse(jsonWrapper.contents);
            
            const meta = data.chart.result[0].meta;
            const price = meta.regularMarketPrice;
            const prevClose = meta.previousClose;
            const change = price - prevClose;
            const percent = (change / prevClose) * 100;
            return { price, change, percent };
        } catch (e) { 
            console.error("Yahoo Fetch Error:", e);
            return null; 
        }
    }

    async function fetchFinnhub(symbol) {
        try {
            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`);
            const data = await res.json();
            return data.c ? { price: data.c, change: data.d, percent: data.dp } : null;
        } catch (e) { return null; }
    }

    async function refreshTicker() {
        const move = document.getElementById('ticker-move');
        let html = '';

        // 1. Fetch Indices (Yahoo via Proxy)
        for (const [sym, name] of Object.entries(indices)) {
            const d = await fetchYahoo(sym);
            if (d) html += formatItem(name, d);
        }

        // 2. Fetch Portfolio (Finnhub)
        for (const sym of userStocks) {
            const d = await fetchFinnhub(sym);
            if (d) html += formatItem(sym, d);
        }

        move.innerHTML = html || "Updating Market Data...";
        renderTags();
    }

    function formatItem(label, d) {
        const isUp = d.change >= 0;
        const alertClass = Math.abs(d.percent) >= 2.0 ? 'alert' : '';
        return `<span class="stock-item ${alertClass}">
            ${label} $${d.price.toLocaleString(undefined,{minimumFractionDigits:2})} 
            <span class="${isUp?'up':'down'}">${isUp?'+':''}${d.change.toFixed(2)} (${isUp?'+':''}${d.percent.toFixed(2)}%)</span>
        </span>`;
    }

    // --- Interaction Logic ---
    let hideTimeout;
    function resetTimer() {
        document.getElementById('controls').classList.remove('hidden');
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => document.getElementById('controls').classList.add('hidden'), 10000);
    }
    ['mousemove','click','touchstart'].forEach(e => window.addEventListener(e, resetTimer));
    resetTimer();

    function addStock() {
        const val = document.getElementById('new-stock').value.toUpperCase().trim();
        if (val && !userStocks.includes(val)) {
            userStocks.push(val);
            localStorage.setItem('stocks', JSON.stringify(userStocks));
            refreshTicker();
            document.getElementById('new-stock').value = '';
        }
    }
    
    function removeStock(s) {
        userStocks = userStocks.filter(x => x !== s);
        localStorage.setItem('stocks', JSON.stringify(userStocks));
        refreshTicker();
    }

    function renderTags() {
        document.getElementById('active-list').innerHTML = userStocks.map(s => `
            <span style="background:var(--border); padding:5px 10px; margin:5px; border-radius:4px; display:inline-block;">
                ${s} <b onclick="removeStock('${s}')" style="cursor:pointer;color:#ff4444;margin-left:5px">Ã—</b>
            </span>
        `).join('');
    }

    function updateUI() {
        const m = document.getElementById('ticker-move');
        m.style.fontSize = document.getElementById('f-size').value + 'px';
        m.style.animationDuration = document.getElementById('f-speed').value + 's';
    }

    function toggleTheme() {
        const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
    }
    document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');

    setInterval(refreshTicker, 60000); // Auto-refresh once per minute
    refreshTicker();
    updateUI();
</script>
</body>
</html>
